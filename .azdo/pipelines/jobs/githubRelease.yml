steps:
  - checkout: self
    persistCredentials: true
    displayName: Checkout source with credentials

  - download: current
    artifact: $(PackageArtifactName)
    displayName: "Get published output"

  - task: ArchiveFiles@2
    inputs:
      rootFolderOrFile: '$(Pipeline.Workspace)/$(PackageArtifactName)/'
      includeRootFolder: false
      archiveType: 'zip' # 'zip' | '7z' | 'tar' | 'wim'. Required. Archive type. Default: zip.
      archiveFile: '$(Build.ArtifactStagingDirectory)/$(PackageArtifactName).zip' # string. Required. Archive file to create. Default: $(Build.ArtifactStagingDirectory)/$(Build.BuildId).zip.

  - task: GithubRelease@1 
    displayName: 'Create GitHub Release'
    inputs:
      gitHubConnection: 'Github ($(RepositoryName))'
      repositoryName: $(RepositoryName)
      action: 'create'
      tagSource: userSpecifiedTag
      
      tag: '$(ReleasePrefix)-v$(Version)'
      title: '$(ReleasePrefix) $(Version)'
      isPreRelease: false
      assets: |
        $(Build.ArtifactStagingDirectory)/$(PackageArtifactName).zip

  - powershell: |
      git pull
      # Delete local latest tag
      git tag -d $(LatestTag)
      # Tag this release as latest
      git tag $(LatestTag) $(ReleasePrefix)-v$(Version)
      # Delete remote latest tag
      git push --delete origin $(LatestTag)
      # Push latest tag
      git push origin $(LatestTag)
    displayName: "Update latest git tag"