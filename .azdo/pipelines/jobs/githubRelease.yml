steps:
  - checkout: self
    persistCredentials: true
    displayName: Checkout source with credentials

  - download: current
    artifact: $(PackageArtifactName)
    displayName: "Get published output"

  - task: ArchiveFiles@2
    inputs:
      rootFolderOrFile: '$(Pipeline.Workspace)/$(PackageArtifactName)/'
      includeRootFolder: false
      archiveType: 'zip' # 'zip' | '7z' | 'tar' | 'wim'. Required. Archive type. Default: zip.
      archiveFile: '$(Build.ArtifactStagingDirectory)/$(PackageArtifactName).zip' # string. Required. Archive file to create. Default: $(Build.ArtifactStagingDirectory)/$(Build.BuildId).zip.

  - powershell: |
      $lowerCaseReleasePrefix = "$(ReleasePrefix)".ToLower()
      $lowerCaseVersion = "$(Version)".ToLower()
      Write-Host "##vso[task.setvariable variable=AzdoPackageName;]$lowerCaseReleasePrefix"
      Write-Host "##vso[task.setvariable variable=AzdoVersion;]$lowerCaseVersion"
    displayName: 'Create Azure Devops compatible package name and version.'

  - task: UniversalPackages@0
    displayName: Publish to Azure Artifacts
    inputs:
      command: publish
      publishDirectory: '$(Pipeline.Workspace)/$(PackageArtifactName)/'
      vstsFeedPublish: 'AppliedOpenSourceTools/FhirLoader'
      vstsFeedPackagePublish: '$(AzdoPackageName)'
      versionOption: custom
      versionPublish: '$(AzdoVersion)'

  - task: GithubRelease@1 
    displayName: 'Create GitHub Release'
    inputs:
      gitHubConnection: 'Github ($(RepositoryName))'
      repositoryName: $(RepositoryName)
      action: 'create'
      tagSource: userSpecifiedTag
      
      tag: '$(ReleasePrefix)-v$(Version)'
      title: '$(ReleasePrefix) $(Version)'
      isPreRelease: false
      assets: |
        $(Build.ArtifactStagingDirectory)/$(PackageArtifactName).zip

  # - script: echo "##vso[task.setvariable variable=PackageReadme]$(cat $(Build.Repository.LocalPath)/deployment/dp)"